---
/**
 * ContentLink component enables Visual Editing for DatoCMS content by providing click-to-edit overlays.
 *
 * This component provides two powerful editing experiences:
 *
 * 1. **Standalone website editing**: When viewing your draft content on the website,
 *    editors can click on any content element to open the DatoCMS editor and modify
 *    that specific field. This works by detecting stega-encoded metadata in the content
 *    and creating interactive overlays.
 *
 * 2. **Web Previews plugin integration**: When your preview runs inside the Visual Editing
 *    mode of the DatoCMS Web Previews plugin, this component automatically establishes
 *    bidirectional communication with the plugin. This enables:
 *    - Clicking content to instantly open the correct field in the side panel
 *    - In-plugin navigation: users can navigate to different URLs within Visual mode
 *      (like a browser navigation bar), and the preview updates accordingly
 *    - Synchronized state between the preview and the DatoCMS interface
 *
 * The component handles client-side routing by:
 * - Listening to navigation requests from the Web Previews plugin via `onNavigateTo`
 * - Notifying the plugin when the URL changes via `setCurrentPath`
 *
 * This integration is completely automatic when running inside the plugin's iframe,
 * with graceful fallback to opening edit URLs in a new tab when running standalone.
 *
 * @see https://www.npmjs.com/package/@datocms/content-link
 * @see https://www.datocms.com/marketplace/plugins/i/datocms-plugin-web-previews
 */

export interface Props {
  /**
   * Whether to enable click-to-edit overlays on mount, or options to configure them.
   *
   * - `true`: Enable click-to-edit mode immediately
   * - `{ scrollToNearestTarget: true }`: Enable and scroll to nearest editable if none visible
   * - `false` or `undefined`: Don't enable automatically (use Alt/Option key to toggle)
   *
   * @example
   * ```astro
   * <ContentLink enableClickToEdit={true} />
   * <ContentLink enableClickToEdit={{ scrollToNearestTarget: true }} />
   * ```
   */
  enableClickToEdit?: boolean | { scrollToNearestTarget?: boolean };

  /**
   * Whether to strip stega-encoded invisible characters from text content after stamping.
   *
   * - `false` (default): Stega encoding remains in the DOM (allows controller to be disposed/recreated)
   * - `true`: Stega encoding is permanently removed (provides clean textContent)
   *
   * @default false
   */
  stripStega?: boolean;
}

const { enableClickToEdit, stripStega = false } = Astro.props;

// Serialize props for client-side script
const enableClickToEditValue =
  enableClickToEdit === undefined
    ? undefined
    : typeof enableClickToEdit === 'boolean'
      ? enableClickToEdit
      : enableClickToEdit;
---

<datocms-content-link
  data-enable-click-to-edit={enableClickToEditValue !== undefined
    ? JSON.stringify(enableClickToEditValue)
    : undefined}
  data-strip-stega={stripStega ? 'true' : undefined}
>
</datocms-content-link>

<script>
  import { createController } from '@datocms/content-link';
  import { navigate } from 'astro:transitions/client';

  class DatoCMSContentLink extends HTMLElement {
    private controller: ReturnType<typeof createController> | null = null;
    private pageLoadHandler: (() => void) | null = null;

    connectedCallback() {
      this.initContentLink();
    }

    disconnectedCallback() {
      this.cleanup();
    }

    private initContentLink() {
      // Read configuration from data attributes
      const enableClickToEditAttr = this.getAttribute('data-enable-click-to-edit');
      const stripStegaAttr = this.getAttribute('data-strip-stega');

      const enableClickToEdit = enableClickToEditAttr
        ? JSON.parse(enableClickToEditAttr)
        : undefined;
      const stripStega = stripStegaAttr === 'true';

      // Initialize the content-link controller
      this.controller = createController({
        // Handle navigation requests from the Web Previews plugin
        // Inside Visual mode, users can navigate to different URLs (like a browser bar)
        // and the plugin will request the preview to navigate accordingly
        onNavigateTo: (path: string) => {
          navigate(path);
        },
        // Strip stega encoding if requested
        stripStega: stripStega,
      });

      // Notify the controller of the current path
      this.controller.setCurrentPath(document.location.toString());

      // Listen for Astro page-load events (fires after client-side navigation)
      //
      // IMPORTANT: Why this works even without <ClientRouter /> (View Transitions):
      //
      // The 'astro:page-load' event fires in two scenarios:
      //
      // 1. WITH View Transitions (<ClientRouter />):
      //    - Event fires on initial page load and after every client-side navigation
      //    - The <ClientRouter /> component enables full SPA-like routing
      //
      // 2. WITHOUT View Transitions:
      //    - Event STILL fires on initial page load if any module imports from 'astro:transitions/client'
      //    - The import above ('import { navigate } from astro:transitions/client') triggers
      //      the module's initialization code, which registers a 'load' event listener that
      //      dispatches 'astro:page-load' on page load
      //    - The navigate() function will work but falls back to full page reload
      //      (it detects no view transitions are enabled and uses location.href instead)
      //    - This means the component works correctly for both scenarios without requiring
      //      the user to enable View Transitions
      //
      // In summary: By importing from 'astro:transitions/client', we ensure this component
      // works seamlessly regardless of whether the site uses View Transitions or not.
      this.pageLoadHandler = () => {
        if (this.controller) {
          this.controller.setCurrentPath(document.location.toString());
        }
      };
      document.addEventListener('astro:page-load', this.pageLoadHandler);

      // Enable click-to-edit mode if requested via prop
      if (enableClickToEdit) {
        if (enableClickToEdit === true) {
          this.controller.enableClickToEdit();
        } else {
          this.controller.enableClickToEdit(enableClickToEdit);
        }
      }
      // Otherwise, click-to-edit overlays are not enabled by default.
      // Users can press and hold Alt/Option key to temporarily enable click-to-edit mode
    }

    private cleanup() {
      if (this.controller) {
        this.controller.dispose();
        this.controller = null;
      }

      if (this.pageLoadHandler) {
        document.removeEventListener('astro:page-load', this.pageLoadHandler);
        this.pageLoadHandler = null;
      }
    }
  }

  // Register the custom element
  if (!customElements.get('datocms-content-link')) {
    customElements.define('datocms-content-link', DatoCMSContentLink);
  }
</script>
